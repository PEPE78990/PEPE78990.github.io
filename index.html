<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>GMod 2D — Balas, Edificios y Casas</title>
<style>
html,body{margin:0;height:100%;font-family:sans-serif;background:#111;color:#eee;}
#gameWrap{display:flex;height:100vh;gap:10px;padding:10px;box-sizing:border-box;}
#canvasWrap{flex:1;display:flex;align-items:stretch;}
canvas{flex:1;background:#0b3d0b;border-radius:6px;display:block;} /* verde oscuro */
#ui{width:300px;background:linear-gradient(180deg,#0f1724,#0b1220);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);}
.btn{display:inline-block;padding:6px 10px;margin:4px;border-radius:6px;border:0;background:#1f2937;color:#eaeaea;cursor:pointer;font-weight:600}
.btn.toggle.on{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:white}
.stat{font-size:13px;margin:6px 0;color:#bcd}
.small{font-size:12px;color:#9fb}
#tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
</style>
</head>
<body>
<div id="gameWrap">
  <div id="canvasWrap">
    <canvas id="game" width="1400" height="800"></canvas>
  </div>
  <div id="ui">
    <h1>GMod 2D — Mini Mundo</h1>
    <div id="tools">
      <button id="spawnNpcBtn" class="btn">Spawn NPC</button>
      <button id="pistolBtn" class="btn">Pistola</button>
      <button id="rifleBtn" class="btn">Rifle</button>
      <button id="mapBtn" class="btn">Cargar siguiente mapa</button>
    </div>
    <div class="stat">NPCs: <span id="npcCount">0</span></div>
    <div class="stat">Arma: <span id="weaponName">Ninguna</span></div>
    <div class="small">Controles: WASD mover, mouse apuntar, click izq disparar</div>
  </div>
</div>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){canvas.width=Math.floor(canvas.clientWidth*DPR);canvas.height=Math.floor(canvas.clientHeight*DPR);ctx.setTransform(DPR,0,0,DPR,0,0);}
window.addEventListener('resize',resizeCanvas);resizeCanvas();

/* --- World --- */
let TILE=64,camera={x:0,y:0,zoom:1};
let maps=[
  {
    name:"Ciudad",
    w:30,h:20,
    tiles:[],
    playerSpawn:{x:1000,y:1000},
    npcSpawns:[{x:1200,y:1200},{x:900,y:950}],
    buildings:[ // colisionables
      {x:600,y:600,w:128,h:128,door:{x:640,y:640,w:64,h:64,interiorMap:"Casa1"}}, 
      {x:1200,y:500,w:128,h:128}
    ]
  },
  {
    name:"Casa1",
    w:10,h:10,
    tiles:[],
    playerSpawn:{x:200,y:200},
    npcSpawns:[],
    buildings:[]
  }
];
maps.forEach(m=>{m.tiles=new Array(m.w*m.h).fill(0);});
let currentMapIndex=0,currentMap=maps[currentMapIndex];
let world={w:currentMap.w*TILE,h:currentMap.h*TILE};

/* --- Player --- */
let player={x:currentMap.playerSpawn.x,y:currentMap.playerSpawn.y,angle:0,speed:250,radius:18,color:'#ffdd57'};

/* --- NPCs --- */
let npcs=[],npcId=1;
function spawnNPC(x,y){npcs.push({id:npcId++,x:x,y:y,radius:16,color:'#f55'});}
const npcCountEl=document.getElementById('npcCount');

/* --- Bullets --- */
let bullets=[];
function shootBullet(){if(currentWeapon===weapons.none) return;
  const dx=Math.cos(player.angle),dy=Math.sin(player.angle);
  bullets.push({x:player.x,y:player.y,vx:dx*currentWeapon.speed,vy:dy*currentWeapon.speed,radius:5,color:currentWeapon.color,damage:currentWeapon.damage});
}

/* --- Weapons --- */
let weapons={
  none:{name:"Ninguna",damage:0,speed:0,color:'#fff'},
  pistol:{name:"Pistola",damage:100,speed:800,color:'#ff0'},
  rifle:{name:"Rifle",damage:999,speed:1200,color:'#0f0'}
};
let currentWeapon=weapons.none;
const weaponNameEl=document.getElementById('weaponName');

/* --- Input --- */
let keys={},mouse={x:0,y:0,worldX:0,worldY:0,left:false};
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  mouse.x=(e.clientX-r.left)*(canvas.width/r.width)/DPR;
  mouse.y=(e.clientY-r.top)*(canvas.height/r.height)/DPR;
  mouse.worldX=camera.x-(canvas.clientWidth/2)*camera.zoom+mouse.x*camera.zoom;
  mouse.worldY=camera.y-(canvas.clientHeight/2)*camera.zoom+mouse.y*camera.zoom;
});
canvas.addEventListener('mousedown',e=>{if(e.button===0) mouse.left=true;shootBullet();});
canvas.addEventListener('mouseup',e=>{if(e.button===0) mouse.left=false;});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

/* --- UI --- */
const spawnNpcBtn=document.getElementById('spawnNpcBtn');
const pistolBtn=document.getElementById('pistolBtn');
const rifleBtn=document.getElementById('rifleBtn');
const mapBtn=document.getElementById('mapBtn');

spawnNpcBtn.onclick=()=>spawnNPC(mouse.worldX,mouse.worldY);
pistolBtn.onclick=()=>{currentWeapon=weapons.pistol;weaponNameEl.textContent=currentWeapon.name;}
rifleBtn.onclick=()=>{currentWeapon=weapons.rifle;weaponNameEl.textContent=currentWeapon.name;}
mapBtn.onclick=()=>{currentMapIndex=(currentMapIndex+1)%maps.length;loadMap(currentMapIndex);}

/* --- Map load --- */
function loadMap(idx){
  currentMap=maps[idx];
  world={w:currentMap.w*TILE,h:currentMap.h*TILE};
  player.x=currentMap.playerSpawn.x;player.y=currentMap.playerSpawn.y;
  npcs=[];currentMap.npcSpawns.forEach(s=>spawnNPC(s.x,s.y));
  bullets=[];
}

/* --- Update Loop --- */
let last=performance.now();
function step(now){
  const dt=Math.min(0.04,(now-last)/1000);last=now;
  update(dt);
  render();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

function update(dt){
  // Player movement + collisions con edificios
  let mvx=0,mvy=0;
  if(keys['w']) mvy-=1;if(keys['s']) mvy+=1;if(keys['a']) mvx-=1;if(keys['d']) mvx+=1;
  const len=Math.hypot(mvx,mvy)||1;
  let nextX=player.x+(mvx/len)*player.speed*dt;
  let nextY=player.y+(mvy/len)*player.speed*dt;

  for(const b of currentMap.buildings){
    if(nextX> b.x && nextX< b.x+b.w && nextY> b.y && nextY<b.y+b.h){
      // entrar si tiene puerta
      if(b.door && nextX> b.door.x && nextX<b.door.x+b.door.w && nextY> b.door.y && nextY<b.door.y+b.door.h){
        const mapName=b.door.interiorMap;
        const mapIdx=maps.findIndex(m=>m.name===mapName);
        if(mapIdx>=0) loadMap(mapIdx);
        return;
      }
      nextX=player.x;nextY=player.y;
    }
  }

  player.x=nextX;player.y=nextY;
  player.angle=Math.atan2(mouse.worldY-player.y,mouse.worldX-player.x);

  // bullets update
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i];
    b.x+=b.vx*dt;b.y+=b.vy*dt;
    // check collisions NPC
    for(let j=npcs.length-1;j>=0;j--){
      let n=npcs[j];
      if(Math.hypot(b.x-n.x,b.y-n.y)<n.radius){npcs.splice(j,1);bullets.splice(i,1);break;}
    }
  }

  camera.x=player.x;camera.y=player.y;
  npcCountEl.textContent=npcs.length;
}

/* --- Render --- */
function render(){
  ctx.fillStyle='#0b3d0b';ctx.fillRect(0,0,canvas.width,canvas.height);

  const left=camera.x-(canvas.clientWidth/2)*camera.zoom;
  const top=camera.y-(canvas.clientHeight/2)*camera.zoom;

  // tiles
  for(let r=0;r<currentMap.h;r++){
    for(let c=0;c<currentMap.w;c++){
      ctx.fillStyle='#164a16';
      ctx.fillRect((c*TILE-left)/camera.zoom,(r*TILE-top)/camera.zoom,TILE/camera.zoom,TILE/camera.zoom);
    }
  }

  // edificios
  for(const b of currentMap.buildings){
    ctx.fillStyle='#555';
    ctx.fillRect((b.x-left)/camera.zoom,(b.y-top)/camera.zoom,b.w/camera.zoom,b.h/camera.zoom);
    if(b.door){ctx.fillStyle='#aa5500';ctx.fillRect((b.door.x-left)/camera.zoom,(b.door.y-top)/camera.zoom,b.door.w/camera.zoom,b.door.h/camera.zoom);}
  }

  // NPCs
  for(const n of npcs){ctx.fillStyle=n.color;ctx.beginPath();ctx.arc((n.x-left)/camera.zoom,(n.y-top)/camera.zoom,n.radius/camera.zoom,0,Math.PI*2);ctx.fill();}

  // Bullets
  for(const b of bullets){ctx.fillStyle=b.color;ctx.beginPath();ctx.arc((b.x-left)/camera.zoom,(b.y-top)/camera.zoom,b.radius/camera.zoom,0,Math.PI*2);ctx.fill();}

  // player
  ctx.fillStyle=player.color;
  ctx.beginPath();
  ctx.arc((player.x-left)/camera.zoom,(player.y-top)/camera.zoom,player.radius/camera.zoom,0,Math.PI*2);
  ctx.fill();
}
</script>
</body>
</html>
