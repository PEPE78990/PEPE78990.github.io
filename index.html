<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>GMod 2D — Armas y NPCs</title>
<style>
html,body{margin:0;height:100%;font-family:sans-serif;background:#111;color:#eee;}
#gameWrap{display:flex;height:100vh;gap:10px;padding:10px;box-sizing:border-box;}
#canvasWrap{flex:1;display:flex;align-items:stretch;}
canvas{flex:1;background:#7eaabd;border-radius:6px;display:block;}
#ui{width:300px;background:linear-gradient(180deg,#0f1724,#0b1220);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);}
.btn{display:inline-block;padding:6px 10px;margin:4px;border-radius:6px;border:0;background:#1f2937;color:#eaeaea;cursor:pointer;font-weight:600}
.btn.toggle.on{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:white}
.stat{font-size:13px;margin:6px 0;color:#bcd}
.small{font-size:12px;color:#9fb}
#tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
</style>
</head>
<body>
<div id="gameWrap">
  <div id="canvasWrap">
    <canvas id="game" width="1400" height="800"></canvas>
  </div>
  <div id="ui">
    <h1>GMod 2D — Armas y NPCs</h1>
    <div id="tools">
      <button id="spawnBtn" class="btn">Spawn Prop</button>
      <button id="spawnNpcBtn" class="btn">Spawn NPC</button>
      <button id="toggleGrab" class="btn toggle">Gravity Gun</button>
      <button id="deleteBtn" class="btn">Borrar</button>
      <button id="mapBtn" class="btn">Cargar siguiente mapa</button>
      <button id="pistolBtn" class="btn">Pistola</button>
      <button id="rifleBtn" class="btn">Rifle</button>
    </div>
    <div class="stat">Herramienta: <span id="toolName">Ninguna</span></div>
    <div class="stat">Props: <span id="propCount">0</span></div>
    <div class="stat">NPCs: <span id="npcCount">0</span></div>
    <div class="stat">Arma: <span id="weaponName">Ninguna</span></div>
    <div class="small">Controles: WASD mover, mouse apuntar, click izq disparar/agarrar</div>
    Zoom: <input id="zoom" type="range" min="0.5" max="1.8" step="0.05" value="1">
  </div>
</div>
<script>
const canvas=document.getElementById('game');const ctx=canvas.getContext('2d');const DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){canvas.width=Math.floor(canvas.clientWidth*DPR);canvas.height=Math.floor(canvas.clientHeight*DPR);ctx.setTransform(DPR,0,0,DPR,0,0);}
window.addEventListener('resize',resizeCanvas);resizeCanvas();

/* --- World/Camera --- */
let TILE=64,camera={x:0,y:0,zoom:1};
let maps=[{name:"Construct",w:60,h:36,tiles:[],playerSpawn:{x:1920,y:1152},npcSpawns:[{x:1000,y:1000},{x:2200,y:1200}]}];
maps[0].tiles=new Array(maps[0].w*maps[0].h).fill(0);maps[0].tiles.fill(1,6* maps[0].w+4,30*maps[0].w+28);
let currentMapIndex=0,currentMap=maps[currentMapIndex];
let world={w:currentMap.w*TILE,h:currentMap.h*TILE};

/* --- Player --- */
let player={x:currentMap.playerSpawn.x,y:currentMap.playerSpawn.y,angle:0,speed:280,radius:18,color:'#ffdd57'};

/* --- Props --- */
let props=[],propId=1;
function spawnProp(x,y,w=46,h=46){const pal=['#f97316','#34d399','#60a5fa','#f472b6','#c084fc','#f59e0b']; props.push({id:propId++,x:x,y:y,w:w,h:h,vx:0,vy:0,ang:0,av:0,mass:1,drag:6,color:pal[(Math.random()*pal.length)|0],static:false});}

/* --- NPCs --- */
let npcs=[],npcId=1;
function spawnNPC(x,y){npcs.push({id:npcId++,x:x,y:y,radius:16,color:'#f55'});}

/* --- Weapons --- */
let weapons={
  none:{name:"Ninguna",damage:0,range:0,color:'#fff',cadence:0},
  pistol:{name:"Pistola",damage:100,range:400,color:'#ff0',cadence:0.5},
  rifle:{name:"Rifle",damage:999,range:700,color:'#0f0',cadence:0.15}
};
let currentWeapon=weapons.none;
const weaponNameEl=document.getElementById('weaponName');

/* --- Input --- */
let keys={},mouse={x:0,y:0,worldX:0,worldY:0,left:false};
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  mouse.x=(e.clientX-r.left)*(canvas.width/r.width)/DPR;
  mouse.y=(e.clientY-r.top)*(canvas.height/r.height)/DPR;
  mouse.worldX=camera.x-(canvas.clientWidth/2)*camera.zoom+mouse.x*camera.zoom;
  mouse.worldY=camera.y-(canvas.clientHeight/2)*camera.zoom+mouse.y*camera.zoom;
});
canvas.addEventListener('mousedown',e=>{if(e.button===0) mouse.left=true; handleShoot();});
canvas.addEventListener('mouseup',e=>{if(e.button===0) mouse.left=false;});
canvas.addEventListener('contextmenu',e=>e.preventDefault());

/* --- Tools/UI --- */
let tool='none',held=null;
const spawnBtn=document.getElementById('spawnBtn');
const spawnNpcBtn=document.getElementById('spawnNpcBtn');
const toggleBtn=document.getElementById('toggleGrab');
const deleteBtn=document.getElementById('deleteBtn');
const mapBtn=document.getElementById('mapBtn');
const pistolBtn=document.getElementById('pistolBtn');
const rifleBtn=document.getElementById('rifleBtn');
const toolNameEl=document.getElementById('toolName');
const propCountEl=document.getElementById('propCount');
const npcCountEl=document.getElementById('npcCount');
const zoomInput=document.getElementById('zoom');

spawnBtn.onclick=()=>spawnProp(mouse.worldX,mouse.worldY);
spawnNpcBtn.onclick=()=>spawnNPC(mouse.worldX,mouse.worldY);
toggleBtn.onclick=()=>{tool=tool==='grab'?'none':'grab';updateUI();}
deleteBtn.onclick=()=>{tool='delete';updateUI();}
mapBtn.onclick=()=>{currentMapIndex=(currentMapIndex+1)%maps.length;loadMap(currentMapIndex);}
pistolBtn.onclick=()=>{currentWeapon=weapons.pistol;updateUI();}
rifleBtn.onclick=()=>{currentWeapon=weapons.rifle;updateUI();}

function updateUI(){toolNameEl.textContent=tool;propCountEl.textContent=props.length;npcCountEl.textContent=npcs.length;weaponNameEl.textContent=currentWeapon.name;}
zoomInput.oninput=()=>{camera.zoom=parseFloat(zoomInput.value);}

/* --- Map loading --- */
function loadMap(idx){
  currentMap=maps[idx];world={w:currentMap.w*TILE,h:currentMap.h*TILE};
  player.x=currentMap.playerSpawn.x;player.y=currentMap.playerSpawn.y;
  npcs=[];currentMap.npcSpawns.forEach(s=>spawnNPC(s.x,s.y));
  props=[]; held=null;
}

/* --- Shooting --- */
let lastShot=0;
function handleShoot(){
  const now=performance.now()/1000;
  if(!mouse.left||currentWeapon===weapons.none||now-lastShot<currentWeapon.cadence) return;
  lastShot=now;
  // Raycast simple
  const dx=mouse.worldX-player.x,dy=mouse.worldY-player.y;
  const dist=Math.hypot(dx,dy);const nx=dx/dist,ny=dy/dist;
  for(let t=0;t<currentWeapon.range;t+=8){
    const px=player.x+nx*t,py=player.y+ny*t;
    for(let i=npcs.length-1;i>=0;i--){
      const n=npcs[i];
      if(Math.hypot(px-n.x,py-n.y)<n.radius){npcs.splice(i,1); break;}
    }
    // Opcional: dibujar rayo
    ctx.strokeStyle=currentWeapon.color;ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(player.x,player.y);ctx.lineTo(px,py);ctx.stroke();
  }
}

/* --- Update/Render Loop --- */
let last=performance.now();
function step(now){const dt=Math.min(0.04,(now-last)/1000);last=now;update(dt);render();requestAnimationFrame(step);}
requestAnimationFrame(step);

function update(dt){
  // player movement
  let mvx=0,mvy=0;
  if(keys['w']) mvy-=1;if(keys['s']) mvy+=1;if(keys['a']) mvx-=1;if(keys['d']) mvx+=1;
  const len=Math.hypot(mvx,mvy)||1;
  player.x+=(mvx/len)*player.speed*dt;
  player.y+=(mvy/len)*player.speed*dt;
  player.angle=Math.atan2(mouse.worldY-player.y,mouse.worldX-player.x);

  // camera
  const camLerp=8*dt;
  camera.x+=(player.x-camera.x)*camLerp;camera.y+=(player.y-camera.y)*camLerp;
  const halfCW=(canvas.clientWidth/2)*camera.zoom;const halfCH=(canvas.clientHeight/2)*camera.zoom;
  camera.x=Math.max(halfCW,Math.min(world.w-halfCW,camera.x));
  camera.y=Math.max(halfCH,Math.min(world.h-halfCH,camera.y));

  updateUI();
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // tiles
  const left=camera.x-(canvas.clientWidth/2)*camera.zoom;
  const top=camera.y-(canvas.clientHeight/2)*camera.zoom;
  const right=left+canvas.clientWidth*camera.zoom;
  const bottom=top+canvas.clientHeight*camera.zoom;
  const startCol=Math.floor(left/TILE),endCol=Math.ceil(right/TILE);
  const startRow=Math.floor(top/TILE),endRow=Math.ceil(bottom/TILE);
  for(let r=startRow;r<endRow;r++){if(r<0||r>=currentMap.h) continue; for(let c=startCol;c<endCol;c++){if(c<0||c>=currentMap.w) continue; const t=currentMap.tiles[r*currentMap.w+c]; const wx=c*TILE,wy=r*TILE; ctx.fillStyle=t===0?'#70a37a':'#bfc0c6'; ctx.fillRect((wx-left)/camera.zoom,(wy-top)/camera.zoom,TILE/camera.zoom,TILE/camera.zoom);}}

  // props
  for(const p of props){ctx.fillStyle=p.color;ctx.fillRect((p.x-p.w/2-left)/camera.zoom,(p.y-p.h/2-top)/camera.zoom,p.w/camera.zoom,p.h/camera.zoom);}

  // NPCs
  for(const n of npcs){ctx.fillStyle=n.color;ctx.beginPath();ctx.arc((n.x-left)/camera.zoom,(n.y-top)/camera.zoom,n.radius/camera.zoom,0,Math.PI*2);ctx.fill();}

  // player
  ctx.fillStyle=player.color;
  ctx.beginPath();
  ctx.arc((player.x-left)/camera.zoom,(player.y-top)/camera.zoom,player.radius/camera.zoom,0,Math.PI*2);
  ctx.fill();
}
</script>
</body>
</html>
